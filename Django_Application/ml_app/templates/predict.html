{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container">
  <div class="logo text-center mb-3">
    <img src="{% static 'images/logo1.png' %}" alt="Logo">
  </div>
  <hr />

  <!-- VIDEO DETECTION -->
  {% if preprocessed_images or faces_cropped_images %}
    {% if no_faces %}
      <div class="alert alert-danger">
        No faces detected. Cannot process the video.
      </div>
    {% else %}
      <h3>Frames Split</h3>
      <div id="preprocessed_images" class="col-12 mt-4 mb-2">
        {% for each_image in preprocessed_images %}
          <img src="{% static each_image %}" class="preprocess" width="auto" height="250" />
        {% endfor %}
      </div>

      <h3>Face Cropped Frames</h3>
      <div id="faces_images" class="col-12 mb-2">
        {% for each_image in faces_cropped_images %}
          <img src="{% static each_image %}" class="faces" width="auto" height="150" />
        {% endfor %}
      </div>

      <div class="report-box text-center" style="border:1px solid #ccc; padding:15px; margin:20px 0; border-radius:8px; background:#fafafa;">
        <h3>Video Detection Report</h3>
        <video id="predict-media" width="640" height="320" controls>
          <source src="{{ original_video }}" type="video/mp4" />
        </video>

        <!-- Button to view detailed prediction -->
        {% if video_result or result %}
        <div class="text-center my-3">
            <button class="btn btn-primary" onclick="window.location.href='{% url 'ml_app:prediction_details' %}'">
                View Detailed Prediction
            </button>
        </div>
        {% endif %}

        {% if output == "REAL" %}
          <h4 class="mx-auto">Final Decision:
            <span class="badge bg-success">REAL</span>
          </h4>
        {% elif output == "FAKE" %}
          <h4 class="mx-auto">Final Decision:
            <span class="badge bg-danger">FAKE</span>
          </h4>
        {% else %}
          <h4 class="mx-auto">Final Decision:
            <span class="badge bg-warning text-dark">{{ output }}</span>
          </h4>
        {% endif %}

        <p><strong>Confidence:</strong> {{ confidence|floatformat:2 }}%</p>
        <p><strong>Identity Variance Score:</strong> {{ identity_score|floatformat:2 }}%</p>
        {% if face_summary %}
          <p><strong>Face Summary:</strong> {{ face_summary }}</p>
        {% endif %}
      </div>
    {% endif %}
  {% endif %}

  <!-- AUDIO DETECTION -->
  {% if result %}
    <div class="report-box text-center" style="border:1px solid #ccc; padding:15px; margin:20px 0; border-radius:8px; background:#fafafa;">
      <h3>Audio Detection Report</h3>
      {% if audio_file_url %}
        <audio controls style="width:320px;">
          <source src="{{ audio_file_url }}" type="audio/wav">
          Your browser does not support the audio element.
        </audio>
      {% endif %}

      {% if result.label == "REAL" %}
        <h4 class="mx-auto">Final Decision:
          <span class="badge bg-success">REAL</span>
        </h4>
      {% elif result.label == "FAKE" %}
        <h4 class="mx-auto">Final Decision:
          <span class="badge bg-danger">FAKE</span>
        </h4>
      {% else %}
        <h4 class="mx-auto">Final Decision:
          <span class="badge bg-warning text-dark">{{ result.label }}</span>
        </h4>
      {% endif %}
      <p><strong>Confidence:</strong> {{ result.confidence|floatformat:2 }}%</p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block js_cripts %}
<script src="{% static 'js/face-api.min.js' %}"></script>
<script>
  $(document).ready(function () {
    const video = document.getElementById("predict-media");
    if (!video) return;

    Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri('/static/json'),
      faceapi.nets.tinyFaceDetector.loadFromUri("/static/json")
    ]);

    var detectionTimeout;
    video.addEventListener("playing", () => {
      var canvas;
      if ($('canvas').length < 1) {
        canvas = faceapi.createCanvasFromMedia(video);
        canvas.style.top = video.offsetTop + "px";
        canvas.style.left = video.offsetLeft + "px";
        document.body.append(canvas);
      }

      const displaySize = { width: video.width, height: video.height - 60 };
      faceapi.matchDimensions(canvas, displaySize);

      detectionTimeout = setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video);
        const resizedDetections = faceapi.resizeResults(detections, displaySize);
        canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
        canvas.style.top = video.offsetTop + "px";
        canvas.style.left = video.offsetLeft + "px";

        resizedDetections.forEach((resultBox, i) => {
          var result = '{{ output|default:"" }}';
          var confidence = '{{ confidence|default:"" }}';
          var drawOptions = { label: result.concat("  " , confidence , "%") };
          if (result == 'REAL'){
            drawOptions["boxColor"] = "#0f0";
          }
          else if (result == 'FAKE'){
            drawOptions["boxColor"] = "#f00";
          }
          var box = { x: resizedDetections[i].box.x, y: resizedDetections[i].box.y, height: 100, width: 100 };
          const drawBox = new faceapi.draw.DrawBox(box, drawOptions);
          drawBox.draw(canvas);
        });
      }, 1);
    });

    video.addEventListener("paused", () => {
      clearTimeout(detectionTimeout);
    });
  });
</script>
{% endblock %}